name: CI Pipeline - Node.js + Snyk + Container Scan

on:
push:
branches:
- main
pull_request:

jobs:
build-test-scan:
runs-on: ubuntu-latest

steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Set up Node.js
    uses: actions/setup-node@v4
    with:
      node-version: 18

  - name: Install dependencies
    run: npm install

  - name: Run tests
    run: npm test || echo "No tests found"

  - name: Snyk Test (Dependencies)
    uses: snyk/actions/node@master
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    with:
      command: test
    continue-on-error: true

  - name: Snyk Monitor (Dependencies)
    uses: snyk/actions/node@master
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    if: always()
    with:
      command: monitor

  - name: Build Docker image
    run: docker build -t nodejs-interview:${{ github.sha }} .

  - name: Snyk Test (Container)
    uses: snyk/actions/docker@master
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    with:
      image: nodejs-interview:${{ github.sha }}
      command: test
    continue-on-error: true

  - name: Snyk Monitor (Container)
    uses: snyk/actions/docker@master
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    if: always()
    with:
      image: nodejs-interview:${{ github.sha }}
      command: monitor
